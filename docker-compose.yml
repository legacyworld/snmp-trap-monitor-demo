services:
  setup-mibs:
    image: alpine:latest
    container_name: snmp_setup
    command: >
      sh -c "apk add --no-cache net-snmp-tools &&
             mkdir -p /shared-mibs &&
             cp -r /usr/share/snmp/mibs/* /shared-mibs/ &&
             chown -R 1000:1000 /shared-mibs"
    volumes:
      - mib-data:/shared-mibs
    networks:
      - snmp-net

  logstash:
    image: docker.elastic.co/logstash/logstash:9.2.1
    container_name: snmp_logstash
    ports:
      - "1062:1062/udp"
      - "9600:9600"
    volumes:
      - ./logstash/pipeline:/usr/share/logstash/pipeline
      - mib-data:/usr/share/logstash/vendor/mibs
    command: >
      logstash -f /usr/share/logstash/pipeline/logstash.conf
    networks:
      snmp-net:
        # Logstashにも固定IPを振っておくと分かりやすい（必須ではない）
        ipv4_address: 172.25.0.5
    depends_on:
      - setup-mibs

  switch-11:
    image: snmp-sender-local
    build: ./sender
    container_name: switch-11
    hostname: switch-11
    environment:
      - TARGET=logstash
      - PORT=1062
      - COMMUNITY=public
      # ここで明示的に渡しても良いですが、前回のスクリプトの自動取得に任せてもOK
      - SWITCH_NAME=Switch
    networks:
      snmp-net:
        ipv4_address: 172.25.0.11
    depends_on:
      - logstash
    restart: unless-stopped

  switch-12:
    image: snmp-sender-local
    build: ./sender
    container_name: switch-12
    hostname: switch-12
    environment:
      - TARGET=logstash
      - PORT=1062
      - COMMUNITY=public
      # ここで明示的に渡しても良いですが、前回のスクリプトの自動取得に任せてもOK
      - SWITCH_NAME=Switch
    networks:
      snmp-net:
        ipv4_address: 172.25.0.12
    depends_on:
      - logstash
    restart: unless-stopped

  switch-13:
    image: snmp-sender-local
    build: ./sender
    container_name: switch-13
    hostname: switch-13
    environment:
      - TARGET=logstash
      - PORT=1062
      - COMMUNITY=public
      # ここで明示的に渡しても良いですが、前回のスクリプトの自動取得に任せてもOK
      - SWITCH_NAME=Switch
    networks:
      snmp-net:
        ipv4_address: 172.25.0.13
    depends_on:
      - logstash
    restart: unless-stopped

  switch-14:
    image: snmp-sender-local
    build: ./sender
    container_name: switch-14
    hostname: switch-14
    environment:
      - TARGET=logstash
      - PORT=1062
      - COMMUNITY=public
      # ここで明示的に渡しても良いですが、前回のスクリプトの自動取得に任せてもOK
      - SWITCH_NAME=Switch
    networks:
      snmp-net:
        ipv4_address: 172.25.0.14
    depends_on:
      - logstash
    restart: unless-stopped

  switch-15:
    image: snmp-sender-local
    build: ./sender
    container_name: switch-15
    hostname: switch-15
    environment:
      - TARGET=logstash
      - PORT=1062
      - COMMUNITY=public
      # ここで明示的に渡しても良いですが、前回のスクリプトの自動取得に任せてもOK
      - SWITCH_NAME=Switch
    networks:
      snmp-net:
        ipv4_address: 172.25.0.15
    depends_on:
      - logstash
    restart: unless-stopped

  switch-16:
    image: snmp-sender-local
    build: ./sender
    container_name: switch-16
    hostname: switch-16
    environment:
      - TARGET=logstash
      - PORT=1062
      - COMMUNITY=public
      # ここで明示的に渡しても良いですが、前回のスクリプトの自動取得に任せてもOK
      - SWITCH_NAME=Switch
    networks:
      snmp-net:
        ipv4_address: 172.25.0.16
    depends_on:
      - logstash
    restart: unless-stopped

  switch-17:
    image: snmp-sender-local
    build: ./sender
    container_name: switch-17
    hostname: switch-17
    environment:
      - TARGET=logstash
      - PORT=1062
      - COMMUNITY=public
      # ここで明示的に渡しても良いですが、前回のスクリプトの自動取得に任せてもOK
      - SWITCH_NAME=Switch
    networks:
      snmp-net:
        ipv4_address: 172.25.0.17
    depends_on:
      - logstash
    restart: unless-stopped

  switch-18:
    image: snmp-sender-local
    build: ./sender
    container_name: switch-18
    hostname: switch-18
    environment:
      - TARGET=logstash
      - PORT=1062
      - COMMUNITY=public
      # ここで明示的に渡しても良いですが、前回のスクリプトの自動取得に任せてもOK
      - SWITCH_NAME=Switch
    networks:
      snmp-net:
        ipv4_address: 172.25.0.18
    depends_on:
      - logstash
    restart: unless-stopped

  switch-19:
    image: snmp-sender-local
    build: ./sender
    container_name: switch-19
    hostname: switch-19
    environment:
      - TARGET=logstash
      - PORT=1062
      - COMMUNITY=public
      # ここで明示的に渡しても良いですが、前回のスクリプトの自動取得に任せてもOK
      - SWITCH_NAME=Switch
    networks:
      snmp-net:
        ipv4_address: 172.25.0.19
    depends_on:
      - logstash
    restart: unless-stopped

  switch-20:
    image: snmp-sender-local
    build: ./sender
    container_name: switch-20
    hostname: switch-20
    environment:
      - TARGET=logstash
      - PORT=1062
      - COMMUNITY=public
      # ここで明示的に渡しても良いですが、前回のスクリプトの自動取得に任せてもOK
      - SWITCH_NAME=Switch
    networks:
      snmp-net:
        ipv4_address: 172.25.0.20
    depends_on:
      - logstash
    restart: unless-stopped

networks:
  snmp-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

volumes:
  mib-data:
